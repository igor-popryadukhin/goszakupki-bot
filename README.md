# Goszakupki Telegram Bot

Телеграм-бот для мониторинга опубликованных закупок на [goszakupki.by](https://goszakupki.by/tenders/posted).

## Возможности

- Периодический опрос первых N страниц каталога (листинг).
- Детальный разбор страниц закупок и фильтрация по ключевым словам, включая семантический анализ через DeepSeek (уведомления только после детразбора).
- Глобальные (единые) настройки: ключевые слова, интервал, число страниц.
- Уведомления с названием, ссылкой и номером закупки. Дедупликация уведомлений.

## Подготовка окружения

1. Создайте файл `.env` по образцу:

   ```
   TELEGRAM_BOT_TOKEN=123456:ABC...
   SOURCE_PAGES_DEFAULT=2
   CHECK_INTERVAL_DEFAULT=300
   HTTP_TIMEOUT_SECONDS=10
   HTTP_CONCURRENCY=3
   RATE_LIMIT_RPS=2
   HTTP_VERIFY_SSL=0
   DETAIL_INTERVAL_SECONDS=3
   DETAIL_MAX_RETRIES=5
   DETAIL_BACKOFF_BASE_SECONDS=60
   DETAIL_BACKOFF_FACTOR=2.0
   DETAIL_BACKOFF_MAX_SECONDS=3600
   # DeepSeek API (опционально)
   DEEPSEEK_API_KEY=sk-...
   DEEPSEEK_ENABLED=1
   DEEPSEEK_MODEL=deepseek-chat
   DEEPSEEK_MIN_SCORE=0.6
   GZ_LIST_ITEM=.tenders-list .tender-card
   GZ_TITLE=.tender-card__title
   GZ_LINK=.tender-card__title a
   GZ_ID_TEXT=.tender-card__meta
   GZ_ID_FROM_HREF=1
   GZ_PREFER_TABLE=1
   # Ограничение доступа (опционально). Если задать, бот потребует авторизацию /login <логин> <пароль>
   AUTH_LOGIN=admin
   AUTH_PASSWORD=secret
   # Детальная страница: текст извлекается из всего документа (селекторы не используются)
   ```

2. Проверка TLS-сертификата при HTTP-запросах отключена в коде (форсированно). Значение `HTTP_VERIFY_SSL` игнорируется.

3. При необходимости добавьте другие переменные из `src/config.py`.
   
   Переменные `GZ_DETAIL_*` управляют выделением «основного контента» на странице закупки для полнотекстового поиска:
   - `GZ_DETAIL_MAIN` — CSS селектор контейнера основной области (если не задан, используется набор типичных кандидатов).
   - `GZ_DETAIL_TEXT_SELECTORS` — CSV-список селекторов внутри основного контейнера; если заданы, текст собирается только из них.
   - `GZ_DETAIL_EXCLUDE` — CSV-список селекторов, которые удаляются перед извлечением текста (меню, хлебные крошки, кнопки).
   
   Парсинг списка:
   - `GZ_PREFER_TABLE` — если 1, использовать табличный разбор раздела заявок (`//*[@id="w0"]/table/tbody/tr`) как основной метод.
   
   Параметры детального сканера:
   - `DETAIL_INTERVAL_SECONDS` — интервал тика детсканера (сканер всегда активен). Обрабатывается по одной записи за тик.
   - `DETAIL_MAX_RETRIES` — максимальное число повторов при неудачной загрузке.
   - `DETAIL_BACKOFF_BASE_SECONDS` — базовая задержка перед повтором.
   - `DETAIL_BACKOFF_FACTOR` — множитель экспоненты (2.0 означает удвоение задержки на каждый повтор).
   - `DETAIL_BACKOFF_MAX_SECONDS` — верхняя граница задержки.

## Авторизация

- Авторизация обязательна. Выполните `/login <логин> <пароль>`.
- Авторизованный чат сохраняется между перезапусками бота.
- Уведомления отправляются только в авторизованный чат.

## Локальный запуск (без Docker)

1. Установите зависимости через Poetry:

   ```bash
   poetry install --only main
   ```

2. Запустите приложение:

   ```bash
   python -m src.app
   ```

## Запуск в Docker

1. Соберите образ:

   ```bash
   docker compose build
   ```

2. Запустите контейнер в фоне:

   ```bash
   docker compose up -d
   ```

3. Логи работы:

   ```bash
   docker logs -f purchases-bot
   ```

4. Остановить и удалить контейнер:

   ```bash
   docker compose down
   ```

Данные (SQLite-база) сохраняются в папку `./data` на хосте.

Примечания
- На этапе листинга уведомления не отправляются — они генерируются только после детального разбора страницы, где выполняется поиск по ключевым словам (и при необходимости по заголовку, если в тексте нет совпадений).
- В статусе показаны только отправленные уведомления (засеянные при включении не считаются).

## Семантический подбор ключевых слов

Для более точного соответствия ключевых слов содержанию закупки можно включить интеграцию с [DeepSeek API](https://platform.deepseek.com/). Детальный сканер отправляет текст закупки и список ключевых слов в модель `deepseek-chat`, которая возвращает релевантные ключи с учётом смысла, а не только прямого вхождения.

Чтобы активировать режим:

1. Получите токен доступа DeepSeek и пропишите его в `DEEPSEEK_API_KEY`.
2. Убедитесь, что `DEEPSEEK_ENABLED=1` (по умолчанию включается автоматически, если задан ключ).
3. При необходимости настройте модель (`DEEPSEEK_MODEL`), порог совпадения (`DEEPSEEK_MIN_SCORE`), ограничение на длину текста (`DEEPSEEK_MAX_CHARS`) и число анализируемых ключей (`DEEPSEEK_MAX_KEYWORDS`).

Если DeepSeek недоступен, бот автоматически возвращается к точному поиску по ключевым словам. В интерфейсе добавления ключей бот показывает рекомендации по формулировке запросов для модели.
